<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Личный кабинет</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../../styles.css" />
    <link rel="stylesheet" href="./styles.css" />
    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://kit.fontawesome.com/3a4b557e16.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="container">
      <div class="user-info mt-3 border rounded p-3" id="userForm"></div>
      <ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="courses-tab"
            data-toggle="tab"
            href="#courses"
            role="tab"
            aria-controls="courses"
            aria-selected="true"
            >Курсы</a
          >
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="courses"
          role="tabpanel"
          aria-labelledby="courses-tab"
        >
          <form id="courseForm" class="border rounded p-3 mt-3">
            <h4>Добавление/изменение курса</h4>
            <div class="row">
              <div class="col-8">
                <div class="form-group">
                  <label>Название</label
                  ><input name="name" type="text" class="form-control" />
                </div>
              </div>
              <div class="col-4">
                <div class="form-group">
                  <label>Количество очков</label
                  ><input name="points" type="number" class="form-control" />
                </div>
              </div>
              <div class="col-12">
                <div class="form-group">
                  <label>Ссылка на лекцию</label
                  ><input name="link" type="text" class="form-control" />
                </div>
              </div>
              <div class="col-12">
                <div class="form-group">
                  <label>Описание</label
                  ><textarea
                    class="form-control"
                    name="description"
                    rows="3"
                  ></textarea>
                </div>
              </div>
            </div>
            <button type="button" id="saveCourse" class="btn btn-primary">
              Сохранить
            </button>
            <button
              type="button"
              id="cancelEditingBtn"
              class="btn btn-secondary d-none"
            >
              Отмена
            </button>
          </form>
          <div class="courses list-group mt-3"></div>
        </div>
      </div>
    </div>
    <script type="module">
      import ApiService from "../../services/api.service.js";
      import SearchService from "../../services/search.service.js";
      import UserService from "../../services/user.service.js";
      let service = new ApiService();
      let userService = new UserService();
      let courseInfo;
      let courseList;

      saveCourse.addEventListener("click", () => {
        let {
          name: { value: name },
          points: { value: points },
          description: { value: description },
          link: { value: link },
        } = courseForm.elements;

        if (!name || !points || !description || !link) {
          alert("Заполните все поля");
          return;
        }
        const newCourse = { name, points, description, link };
        if (courseInfo) {
          newCourse.id = courseInfo.id;
          service.updateCourse(newCourse).then(() => {
            cancelEditing();
            getCourses();
          });
        } else {
          service.addCourse(newCourse).then(() => {
            cancelEditing();
            getCourses();
          });
        }
      });

      let onEditCourseClick = ({ target }) => {
        const btn = target.closest("button");
        if (btn.dataset.id) {
          if (target.closest(".btn-link")) {
            window.location.href = service.url + "/course/index.html?id="+btn.dataset.id;
            return;
          }
          courseInfo = courseList.find((c) => c.id == btn.dataset.id);
          setCourse(courseInfo);
        }
      };

      if (!userService.token) {
        window.location.href = service.url + "/enter";
      }
      let coursesElem = document.querySelector(".courses");
      coursesElem.addEventListener("click", onEditCourseClick);
      let userInfo;

      let cancelEditing = () => {
        let { name, points, description, link } = courseForm.elements;
        name.value = "";
        points.value = "";
        description.value = "";
        link.value = "";
        courseInfo = null;
        cancelEditingBtn.classList.add("d-none");
      };

      cancelEditingBtn.addEventListener("click", cancelEditing);

      let updateUser = () => {
        service.getUserInfo().then((user) => {
          if (user) {
            userInfo = user;
            userForm.innerHTML = `
        <h3>Ваши данные <i class="fas fa-sign-out-alt ml-3" id="exit" title="Выйти"></i></h3>
        <div class="row">
          <div class="col-6">
            <div class="form-group">
              <label>ФИО</label>
              <h6>${`${user.surname} ${user.name} ${user.middlename}`}</h6>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label>Email</label>
              <h6>${user.email}</h6>
            </div>
          </div>
        </div>
        `;
            getCourses();
            exit.addEventListener("click", () => {
              userService.saveToken(null);
              window.location.href = service.url + "/enter";
            });
          }
        });
      };

      function setCourse(course) {
        Object.keys(course).forEach((key) => {
          if (courseForm.elements[key]) {
            courseForm.elements[key].value = course[key];
          }
        });
        cancelEditingBtn.classList.remove("d-none");
      }

      function getCourses() {
        service.getCourses().then((courses) => {
          coursesElem.innerHTML = "";
          courseList = courses || [];
          if (!courses || !courses.length) {
            coursesElem.innerHTML = `
              <div class='text-center mt-3'>
                <small class='text-muted text-center d-block'>Вам не доступно ни одного курса</small>
              <div>`;
            return;
          }

          courses.forEach((course) => {
            let courseElem = document.createElement("div");
            courseElem.innerHTML = `
            <button data-id="${course.id}" type="button" class="list-group-item list-group-item-action">
              <div class="row">
                <div class="col-10">
                  <span>${course.name}</span>
                </div>
                <div class="col-2 text-right">
                  <span class="badge badge-info ">${course.points} очков</span>
                </div>
              </div>
              <small class="mt-3 text-muted">${course.description}</small>
              <div class="btn btn-link pl-0">Пройти тест</div>
            </button>+
            `;
            coursesElem.append(courseElem.firstElementChild);
          });
        });
      }

      updateUser();
    </script>
  </body>
</html>
